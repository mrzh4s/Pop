<IfModule mod_rewrite.c>
  RewriteEngine On

  # ---------------------------------------
  # 1) Force HTTPS (handles proxies/CDN)
  #    307 preserves POST/PUT bodies
  # ---------------------------------------
  RewriteCond %{HTTPS} !=on
  RewriteCond %{HTTP:X-Forwarded-Proto} !https [OR]
  RewriteCond %{HTTP:Forwarded} !"proto=https"
  RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=307]

  # ---------------------------------------
  # 2) Serve existing files/directories as-is
  #    (do this BEFORE any pretty-URL logic)
  # ---------------------------------------
  RewriteCond %{REQUEST_FILENAME} -f [OR]
  RewriteCond %{REQUEST_FILENAME} -d
  RewriteRule ^ - [L]

  # ---------------------------------------
  # 3) Optional: Remove ".php" in browser URL
  #    External redirect only when user explicitly
  #    requested a .php file
  # ---------------------------------------
  RewriteCond %{THE_REQUEST} \s/+(.+?)\.php[\s?] [NC]
  RewriteRule ^ %1 [L,R=301]

  # ---------------------------------------
  # 4) Optional: Internally map extensionless -> .php
  #    (lets /about load /about.php if it exists)
  #    Put BEFORE front controller to avoid hijacking.
  # ---------------------------------------
  RewriteCond %{REQUEST_FILENAME}.php -f
  RewriteRule ^(.+)$ $1.php [L]

  # ---------------------------------------
  # 5) Front controller
  #    (route the rest to index.php)
  # ---------------------------------------
  RewriteRule ^ index.php [L]
</IfModule>
